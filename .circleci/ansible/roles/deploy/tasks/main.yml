---
- name: Disable IPv6 with sysctl
  become: true
  sysctl: name={{ item }} value=1 state=present reload=yes
  with_items:
    - net.ipv6.conf.all.disable_ipv6
    - net.ipv6.conf.default.disable_ipv6
    - net.ipv6.conf.lo.disable_ipv6

- name: Creates kubernetes directory
  file:
    path: ~/kubernetes
    state: directory

- name: Creates techtrends directory
  file:
    path: ~/techtrends
    state: directory

- name: Unarchive Kubernetes
  unarchive:
    src: kubernetes.tar.gz
    dest: /home/ubuntu/kubernetes/

- name: Install k3s
  shell: |
    cd /home/ubuntu/
    curl -sfL https://get.k3s.io | sh -s - --write-kubeconfig-mode 644
    sudo chmod 644 /etc/rancher/k3s/k3s.yaml

- name: Deployments and Services
  shell: |
    cd /home/ubuntu/kubernetes/kubernetes/
    kubectl get nodes
    kubectl apply -f .
    kubectl port-forward -n app  service/techtrends --address 0.0.0.0 3111:4111